<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>Fixing UIColor | Mark Sands</title>
	<meta name="description" content="UIColorUIColor is a commonly used class that represents color and sometimes opacity. As it turns out, UIColor is a class cluster made up of a couple of priva...">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://marksands.github.io/2013/07/11/fixing-uicolor.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Mark Sands" href="http://marksands.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-41405801-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7a6e4cc366f8f533b056936cf9bcb85d?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Mark Sands</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			
<li>
	<a href="http://marksands.github.io/feed.xml" title="Follow RSS feed">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>



<li>
	<a href="mailto:marksands07@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>













<li>
	<a href="https://github.com/marksands" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/marksands" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">Fixing UIColor</h1>
    <p class="meta">
    July 11, 2013
    
    </p>
  </header>
  <section class="post-content"><h3 id="uicolor">UIColor</h3>

<p><code>UIColor</code> is a commonly used class that represents color and sometimes opacity. As it turns out, <code>UIColor</code> is a class cluster made up of a couple of private concrete subclasses. 
Class clusters group a number of private concrete subclasses under a public abstract superclass; this is based on the abstract factory design pattern.<a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaObjects/CocoaObjects.html#//apple_ref/doc/uid/TP40002974-CH4-SW34">¹</a></p>

<!-- more -->

<h3 id="red-green-blue">Red, Green, Blue</h3>

<p>As of iOS 6, subclasses of the <code>UIColor</code> class cluster include <a href="https://github.com/nst/iOS-Runtime-Headers/blob/master/Frameworks/UIKit.framework/UIDeviceWhiteColor.h"><code>UIDeviceWhiteColor</code></a> 
and <a href="https://github.com/nst/iOS-Runtime-Headers/blob/master/Frameworks/UIKit.framework/UIDeviceRGBColor.h"><code>UIDeviceRGBColor</code></a>. 
Unfortunately for the programmer, only <code>UIDeviceRGBColor</code> knows what red, green, and blue are, making it challenging to get the color components from a generic <code>UIColor</code> object.</p>

<p>According to Apple, <code>UIColor</code>&#39;s method <code>getRed:green:blue:alpha:</code> will return the red, green, and blue color components if the color is within the RGB color space. 
If the color is in a compatible color space, the color is converted into RGB format and its components are returned to your application. 
If the color is not in a compatible color space, the parameters are unchanged.<a href="http://developer.apple.com/library/ios/#documentation/UIKit/Reference/UIColor_Class/Reference/Reference.html#//apple_ref/occ/instm/UIColor/getRed:green:blue:alpha:">²</a> 
And therein lies the problem.</p>

<p>Say we have an API that accepts a <code>UIColor</code> object and uses its color components for some arbitrary computation. One might think, &quot;<code>getRed:green:blue:alpha</code> to the rescue!&quot; 
Sadly, this bruteforce approach will only work if the <code>UIColor</code> object is of the RGB color space, or the <code>UIDeviceRGBColor</code> class. The only approach is to inspect and retreive 
the color components using the Core Graphics functions <code>CGColorGetNumberOfComponents(color.CGColor)</code> and <code>CGColorGetComponents(color.CGColor)</code>. This approach quickly doesn&#39;t scale if you 
are constantly retreiving the color components for various reasons, so it would be ideal if <code>UIColor</code> handled this for us under the hood. For the curious, I have 
<a href="http://openradar.appspot.com/radar?id=3114410">created a radar</a> in hopes to address this issue.</p>

<h3 id="a-universal-selector">A Universal Selector</h3>

<p>Luckily for us, we have <em>objc/funtime.h</em> that will provide exactly what we want. Using method swizzling, we can create an alternative to <code>getRed:green:blue:alpha</code> that 
checks the number of the color components using <code>getRed:green:blue:alpha</code> for <code>UIDeviceRGBColor</code> objects and <code>getWhite:alpha</code> for <code>UIDeviceWhiteColor</code> objects. The color 
components from <code>UIDeviceWhiteColor</code> objects are calculated by using the white balance as a multiplier for each RGB component. Using this approach, we have successfully 
moved the redundant color space checking behind the scenes and provided ourselves with much cleaner code snippets. The category implementation is below.</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import &lt;objc/runtime.h&gt;
</span>
<span class="k">@implementation</span> <span class="nc">UIColor</span> <span class="p">(</span><span class="nl">ColorComponents</span><span class="p">)</span>

<span class="err">+</span> <span class="err">(</span><span class="nc">void</span><span class="p">)</span><span class="n">initialize</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">==</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">class</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">Method</span> <span class="n">oldMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">UIColor</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">getRed</span><span class="o">:</span><span class="n">green</span><span class="o">:</span><span class="n">blue</span><span class="o">:</span><span class="n">alpha</span><span class="o">:</span><span class="p">));</span>
        <span class="n">Method</span> <span class="n">newMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">UIColor</span><span class="p">.</span><span class="n">class</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">eds_getRed</span><span class="o">:</span><span class="n">green</span><span class="o">:</span><span class="n">blue</span><span class="o">:</span><span class="n">alpha</span><span class="o">:</span><span class="p">));</span>
        <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">oldMethod</span><span class="p">,</span> <span class="n">newMethod</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">eds_getRed</span><span class="o">:</span><span class="p">(</span><span class="n">CGFloat</span> <span class="o">*</span><span class="p">)</span><span class="n">red</span> <span class="n">green</span><span class="o">:</span><span class="p">(</span><span class="n">CGFloat</span> <span class="o">*</span><span class="p">)</span><span class="n">green</span> <span class="n">blue</span><span class="o">:</span><span class="p">(</span><span class="n">CGFloat</span> <span class="o">*</span><span class="p">)</span><span class="n">blue</span> <span class="n">alpha</span><span class="o">:</span><span class="p">(</span><span class="n">CGFloat</span> <span class="o">*</span><span class="p">)</span><span class="n">alpha</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CGColorGetNumberOfComponents</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">CGColor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nf">eds_getRed</span><span class="p">:</span><span class="n">red</span> <span class="nf">green</span><span class="p">:</span><span class="n">green</span> <span class="nf">blue</span><span class="p">:</span><span class="n">blue</span> <span class="nf">alpha</span><span class="p">:</span><span class="n">alpha</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CGColorGetNumberOfComponents</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">CGColor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CGFloat</span> <span class="n">white</span><span class="p">;</span>
        <span class="n">CGFloat</span> <span class="n">m_alpha</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">self</span> <span class="nf">getWhite</span><span class="p">:</span><span class="o">&amp;</span><span class="n">white</span> <span class="nf">alpha</span><span class="p">:</span><span class="o">&amp;</span><span class="n">m_alpha</span><span class="p">])</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">red</span> <span class="o">=</span> <span class="n">white</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
            <span class="o">*</span><span class="n">green</span> <span class="o">=</span> <span class="n">white</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
            <span class="o">*</span><span class="n">blue</span> <span class="o">=</span> <span class="n">white</span> <span class="o">*</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
            <span class="o">*</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">m_alpha</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<h3 id="references">References</h3>

<ul>
<li><a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaObjects/CocoaObjects.html#//apple_ref/doc/uid/TP40002974-CH4-SW34">[1] Cocoa Fundamentals Guide</a></li>
<li><a href="http://developer.apple.com/library/ios/#documentation/UIKit/Reference/UIColor_Class/Reference/Reference.html#//apple_ref/occ/instm/UIColor/getRed:green:blue:alpha:">[2] getRed:green:blue:alpha:</a></li>
</ul>
</section>
</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <a id="prev-post" href="/2013/06/24/trampolines-and-higher-order-messaging.html">
      <span class="page-title">Trampolines & Higher Order Messaging</span>
      <span class="nav-label">
        <i class="fa fa-chevron-left"></i> Prev
      </span>
    </a>
    
    
    <a id="next-post" href="/2014/01/03/inspecting-third-party-apps.html">
       <span class="page-title">Inspecting Third Party Apps</span>
       <span class="nav-label">
        Next <i class="fa fa-chevron-right"></i>
       </span>
     </a>
    
</div>


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'marksandsgithub';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    


<footer class="site-footer">
	<p class="text">Powered by <a href="http://jekyllrb.com">Jekyll</a>
</p>
</footer>


  </body>
</html>
