<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>Trampolines & Higher Order Messaging | Mark Sands</title>
	<meta name="description" content="TrampolinesA trampoline is a small piece of code that is created at run time when the address of a nested function is taken. It normally resides on the stack...">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://marksands.github.io/2013/06/24/trampolines-and-higher-order-messaging.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Mark Sands" href="http://marksands.github.io/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-41405801-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7a6e4cc366f8f533b056936cf9bcb85d?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Mark Sands</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			
<li>
	<a href="http://marksands.github.io/feed.xml" title="Follow RSS feed">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>



<li>
	<a href="mailto:marksands07@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>













<li>
	<a href="https://github.com/marksands" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/marksands" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">Trampolines & Higher Order Messaging</h1>
    <p class="meta">
    June 24, 2013
    
    </p>
  </header>
  <section class="post-content"><h3 id="trampolines">Trampolines</h3>

<p>A trampoline is a small piece of code that is created at run time when the address of a nested function is taken. 
It normally resides on the stack, in the stack frame of the containing function. The word trampoline is used because execution jumps 
into the trampoline object and then immediately jumps out.<a href="http://gcc.gnu.org/onlinedocs/gccint/Trampolines.html">¹</a></p>

<!-- more -->

<p>A trampoline object in Objective-C is a subclass of <code>NSProxy</code> that is returned by a method and acts like a delegate by forwarding messages to another object. 
This brings us to higher order messaging.</p>

<h3 id="higher-order-messaging">Higher Order Messaging</h3>

<p>Higher order messaging allows messages that have messages as arguments. This is analogous to languages that treat functions as a first-class data type, 
like Lisp, Haskell, and PHP do. Even C and its descendants can use function pointers, although it&#39;s not as pretty. Objective-C is a perfect candidate for 
higher order messaging, or HOM, since the language is known for its message passing traits.<a href="http://www.macdevcenter.com/pub/a/mac/2004/07/16/hom.html?page=last&amp;x-order=date">²</a></p>

<p>The code for a trampoline object is quite trivial. The implementation below is specialized for an <code>NSArray</code> and assumes ARC is enabled. The <code>#pragma</code> cruff 
is necessary to silence warnings.</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TFFTrampoline</span> <span class="p">:</span> <span class="nc">NSProxy</span> <span class="p">{</span>
    <span class="n">id</span> <span class="n">tff_target</span><span class="p">;</span>
    <span class="n">SEL</span> <span class="n">tff_selector</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">+</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">trampolineWithTarget</span><span class="o">:</span><span class="n">aTarget</span> <span class="n">selector</span><span class="o">:</span><span class="p">(</span><span class="n">SEL</span><span class="p">)</span><span class="n">newSelector</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">TFFTrampoline</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation</span><span class="p">:(</span><span class="n">NSInvocation</span><span class="o">*</span><span class="p">)</span><span class="nv">anInvocation</span> <span class="p">{</span>
<span class="cp">#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Warc-performSelector-leaks"
</span>    <span class="n">id</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">tff_target</span> <span class="nf">performSelector</span><span class="p">:</span><span class="n">tff_selector</span> <span class="nf">withObject</span><span class="p">:</span><span class="n">anInvocation</span><span class="p">];</span>
    <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">setReturnValue</span><span class="p">:</span><span class="o">&amp;</span><span class="n">result</span><span class="p">];</span>
<span class="cp">#pragma clang diagnostic pop
</span><span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">methodSignatureForSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[[</span><span class="n">tff_target</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="nf">methodSignatureForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="nf">tff_initWithTarget</span><span class="p">:</span><span class="n">aTarget</span> <span class="n">selector</span><span class="o">:</span><span class="p">(</span><span class="n">SEL</span><span class="p">)</span><span class="n">aSelector</span> <span class="p">{</span>
    <span class="n">tff_target</span> <span class="o">=</span> <span class="n">aTarget</span><span class="p">;</span>
    <span class="n">tff_selector</span> <span class="o">=</span> <span class="n">aSelector</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">+</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">trampolineWithTarget</span><span class="o">:</span><span class="n">aTarget</span> <span class="n">selector</span><span class="o">:</span><span class="p">(</span><span class="n">SEL</span><span class="p">)</span><span class="n">aSelector</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[[</span><span class="n">self</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">tff_initWithTarget</span><span class="p">:</span><span class="n">aTarget</span> <span class="nf">selector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>This is the basic implementation for a trampoline object. For our intents and purposes, we will be using it to create a category on <code>NSArray</code> to add a <code>collect</code> method. You might see some 
programmers use <code>do</code> as their method name of choice, but since <code>do</code> is a keyword, I will avoid that route.</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">NSArray</span> <span class="p">(</span><span class="nl">Collect</span><span class="p">)</span>
<span class="err">-</span> <span class="err">(</span><span class="nc">id</span><span class="p">)</span><span class="n">collect</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">NSArray</span> <span class="p">(</span><span class="nl">Collect</span><span class="p">)</span>

<span class="err">-</span> <span class="err">(</span><span class="nc">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">collect</span><span class="o">:</span><span class="p">(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="n">anInvocation</span> <span class="p">{</span>
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">resultArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__unsafe_unretained</span> <span class="n">id</span> <span class="n">resultObject</span><span class="p">;</span>
        <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">invokeWithTarget</span><span class="p">:</span><span class="n">obj</span><span class="p">];</span>
        <span class="p">[</span><span class="n">anInvocation</span> <span class="nf">getReturnValue</span><span class="p">:</span><span class="o">&amp;</span><span class="n">resultObject</span><span class="p">];</span>
        <span class="p">[</span><span class="n">resultArray</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">resultObject</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">resultArray</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">collect</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">TFFTrampoline</span> <span class="nf">trampolineWithTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">collect</span><span class="p">:)];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div>
<p>Here, our <code>NSArray</code> category implements a public <code>collect</code> method that will return our trampoline object to bounce the method argument to the private <code>collect:</code> method 
that uses the forwarded <code>NSInvocation</code> to assist with the bouncing.</p>

<p>Last but not least, below is an example of how one would use this implementation.</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="cp">#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wincompatible-pointer-types"
</span>    <span class="err">@autoreleasepool</span> <span class="p">{</span>
        <span class="c1">// Modify
</span>        <span class="n">NSArray</span> <span class="o">*</span><span class="n">smallCasedString</span> <span class="o">=</span> <span class="p">@[</span> <span class="s">@"small"</span><span class="p">,</span> <span class="s">@"cased"</span><span class="p">,</span> <span class="s">@"words"</span> <span class="p">];</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">uppercasedStrings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">smallCasedString</span> <span class="nf">collect</span><span class="p">]</span> <span class="nf">uppercaseString</span><span class="p">];</span>
        <span class="c1">// ( @"SMALL", @"CASED", @"WORDS" )
</span>
        <span class="c1">// Convert
</span>        <span class="n">NSArray</span> <span class="o">*</span><span class="n">floats</span> <span class="o">=</span> <span class="p">@[</span> <span class="err">@</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="p">),</span> <span class="err">@</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">71</span><span class="p">),</span> <span class="err">@</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">577</span><span class="p">)</span> <span class="p">];</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">floatStrings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">floats</span> <span class="nf">collect</span><span class="p">]</span> <span class="nf">stringValue</span><span class="p">];</span>
        <span class="c1">// ( @"3.14", @"2.71", @"0.577" )
</span>
        <span class="c1">// An exercise for the reader could be to implement a select method to filter results
</span>        <span class="n">NSArray</span> <span class="o">*</span><span class="n">dogs</span> <span class="o">=</span> <span class="p">@[</span> <span class="s">@"Scooby"</span><span class="p">,</span> <span class="s">@"Clifford"</span><span class="p">,</span> <span class="s">@"Snoopy"</span> <span class="p">];</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">redDogs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">dogs</span> <span class="nf">select</span><span class="p">]</span> <span class="nf">isNamed</span><span class="p">:</span><span class="s">@"Clifford"</span><span class="p">];</span>
        <span class="c1">// ( @"Clifford" )
</span>    <span class="p">}</span>
<span class="cp">#pragma clang diagnostic pop
</span><span class="p">}</span>
</code></pre></div>
<p>And that&#39;s all there is to it. This might look more complicated than necessary to accomplish iteration, but benefits do exist. Having a one-off solution is 
good for writing this once and only once, which can also provide assurance of getting rid of one-off errors, and loops are optimized more easily when they are
internalized in this manner.</p>

<p>There are many more uses for HOM than iteration, but methods such as <code>collect</code> seem to be the most commonly used higher-order methods. Another use 
case could be a protocol checker to act as a proxy for an object and only pass messages through that are part of a given protocol, but the possibilities are, 
of course, endless.<a href="http://www.macdevcenter.com/pub/a/mac/2004/07/16/hom.html?page=last&amp;x-order=date">²</a></p>

<h3 id="references">References</h3>

<ul>
<li><a href="http://gcc.gnu.org/onlinedocs/gccint/Trampolines.html">[1] GCC Docs 17.12 Trampolines for Nested Functions</a></li>
<li><a href="http://www.macdevcenter.com/pub/a/mac/2004/07/16/hom.html?page=last&amp;x-order=date">[2] Higher-Order Messages in Cocoa</a></li>
<li><a href="http://blog.metaobject.com/2009/01/simple-hom.html">[3] Simple HOM</a></li>
</ul>
</section>
</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <a id="prev-post" href="/2013/05/31/builder-pattern.html">
      <span class="page-title">Builder Pattern</span>
      <span class="nav-label">
        <i class="fa fa-chevron-left"></i> Prev
      </span>
    </a>
    
    
    <a id="next-post" href="/2013/07/11/fixing-uicolor.html">
       <span class="page-title">Fixing UIColor</span>
       <span class="nav-label">
        Next <i class="fa fa-chevron-right"></i>
       </span>
     </a>
    
</div>


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'marksandsgithub';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    


<footer class="site-footer">
	<p class="text">Powered by <a href="http://jekyllrb.com">Jekyll</a>
</p>
</footer>


  </body>
</html>
