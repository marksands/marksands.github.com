<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>A Debugging Story</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

      <div id="page" class="hentry">
        
        <header class="the-header">
          <div class="unit-head">
            <div class="unit-inner unit-head-inner">
              <p class="logo"><a href=""></a></p>
              <nav class="nav-global">
                <ul>
                  <li class="github"><a href="http://github.com/marksands">github</a></li>
                  <li class="twitter"><a href="http://twitter.com/marksands">twitter</a></li>
                </ul>
              </nav>
            </div><!-- unit-inner -->
          </div><!-- unit-head -->
        </header>
        
        <div class="body" role="main">
          
          <!-- begin ads -->
          <article class="unit-article layout-page">
            <div class="unit-inner unit-article-inner">
              <div class="content">
                <div class="bd">
                  <div class="entry-content">
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
					<!-- github responsive -->
					<ins class="adsbygoogle"
					     style="display:block"
					     data-ad-client="ca-pub-5267577598224051"
					     data-ad-slot="6247920616"
					     data-ad-format="auto"></ins>
					<script>
					(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
                  </div>
                </div>
              </div>
            </div>
          </article>
          <!-- end ads -->
          
          <div class="unit-body">
            <div class="unit-inner unit-body-inner">
              <div class="entry-content">
                <article class="unit-article layout-post">
  <div class="unit-inner unit-article-inner">
    <div class="content">
      <header>
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <!-- <h1 class="h2 entry-title">A Debugging Story</h1> -->
            
            
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="bd">
        <div class="entry-content">
          <h1>A Debugging Story</h1>
          <h3>Forward</h3>

<p>The following is a synopsis of a crash that stumped my team for several days, and the process we took to investigate such bizarre behavior and ultimately diagnose and fix the problem. I&#39;ll go over how we arrived at our solution and the debugging steps we took to get there. Hopefully by the end of the story you&#39;ll have learned something along the way.</p>

<h3>Unrecognized Selector Sent To Instance</h3>

<p>It began with initializing Parse. A simple call to <code>[Parse setApplicationid:@&quot;jumbledString&quot; clientId:@&quot;anotherString&quot;];</code> in the first line of <code>applicationDidFinishLaunching:withOptions:</code>. This is very standard procedure, and the Parse documentation even says to do this. Unfortunately, the app would consistently crash on this line with <code>[__NSCFBoolean stringByReplacingOccurrencesOfString:withString:]: unrecognized selector sent to instance</code>.</p>

<p>To make a long story short, I&#39;ll leave out the obvious debugging tidbits and drive closer to the point.</p>

<p>Using a different, older version of Parse.framework didn&#39;t help either, so it was time to look at the stack trace more carefully to see where exactly the crash was happening. Here&#39;s the relevant parts of the stack trace:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"> #0: `-[NSFileManager _URLForReplacingItemAtURL:error:]
 #1: `_NSCreateTemporaryFile_Protected + 404
 #2: `_NSWriteDataToFileWithExtendedAttributes + 276
 #3: `_NSWriteBytesToFileWithExtendedAttributes + 76
 #4: `writeStringToURLOrPath + 240
 #5: `-[NSString writeToFile:atomically:encoding:error:] +
 #6: `+[PFInternalUtils checkCacheApplicationId] + 700 at PFInternalUtils.m:239
 #7: `+[Parse setApplicationId:clientKey:] + 134 at Parse.m:54
</code></pre></div>
<h3>Register Read</h3>

<p>I put a symbolic breakpoint on <code>-[NSString writeToFile:atomically:encoding:error:]</code> to see if anything looked suspicious. When the breakpoint hit, I opened lldb and did a <code>register read</code> to dump the assembly registers to see if anything stood out. Take a look:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(lldb) register read
General Purpose Registers:
        r0 = 0x0015f7b8  @&quot;jumbledString&quot;
        r1 = 0x29115a7b  &quot;writeToFile:atomically:encoding:error:&quot;
        r2 = 0x14641a30
        r3 = 0x00000001
        r4 = 0x14641a30
        r5 = 0x0015f7b8  @&quot;anotherString&quot;
        r6 = 0x00000000
        r7 = 0x0031d5ec
        r8 = 0x0014e996  &quot;dataFilePath:&quot;
        r9 = 0x00000000
       r10 = 0x14641000
       r11 = 0x290ea935  &quot;fileExistsAtPath:&quot;
       r12 = 0x2618d131  Foundation`-[NSString writeToFile:atomically:encoding:error:] + 1
        sp = 0x0031d5b8
        lr = 0x0012679d  Aerie`+[PFInternalUtils checkCacheApplicationId] + 701 at PFInternalUtils.m:239
        pc = 0x2618d130  Foundation`-[NSString writeToFile:atomically:encoding:error:]
      cpsr = 0x60000030
</code></pre></div>
<p>Clearly it was writing something to file at a particular path, and that&#39;s where things went awry. I figured if I could get the exact path it was writing to, and the contents, maybe I could bypass this check and Parse would magically work. Fortunately, register 10 had what we needed:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(lldb) po 0x14641000
/var/mobile/Containers/Data/Application/17F2392D-56EF-4259-84AD-1CD9EEA58E89/Library/Private Documents/Parse/applicationId
</code></pre></div>
<p>I assumed applicationId was a file that held the applicationId string, for whatever reason. The existence of <code>fileExistsAtPath:</code> in the registers led me to believe that if I created this file at this exact path, all would be well. So I got rid of the call to Parse, and temporarily replaced it with a series of commands to write the applicationId to a file at that location.</p>

<p>Shockingly, I got the same crash <code>[__NSCFBoolean stringByReplacingOccurrencesOfString:withString:]: unrecognized selector sent to instance</code>. Now this led me down an entirely different rabbit whole that I&#39;ll spare you from (it involved POSIX file permissions, and chmodding a bunch of directories).</p>

<h3>_URLForReplacingItemAtURL:error:</h3>

<p>I decided to open Hopper.app and look at the internals of <code>-[NSFileManager _URLForReplacingItemAtURL:error:]</code>. Sure enough, I spotted a call to <code>stringByReplacingOccurrancesOfString:withString:</code> halfway down the disassembled code:</p>
<div class="highlight"><pre><code class="language-objc" data-lang="objc">    <span class="n">rax</span> <span class="o">=</span> <span class="n">CFBundleGetValueForInfoDictionaryKey</span><span class="p">(</span><span class="n">CFBundleGetMainBundle</span><span class="p">(),</span> <span class="s">@&quot;CFBundleName&quot;</span><span class="p">);</span>
    <span class="n">var_16</span> <span class="o">=</span> <span class="p">[</span><span class="n">rax</span> <span class="nl">stringByReplacingOccurrencesOfString</span><span class="p">:</span><span class="s">@&quot;/&quot;</span> <span class="nl">withString</span><span class="p">:</span><span class="s">@&quot;:&quot;</span><span class="p">];</span>
</code></pre></div>
<p>This was the eureka moment I&#39;d been waiting for. The rax register should be an <code>NSString</code>, but it&#39;s somehow getting converted to a boolean object. To make sure I wasn&#39;t crazy, I copied <code>CFBundleGetValueForInfoDictionaryKey(CFBundleGetMainBundle(), @&quot;CFBundleName&quot;);</code> into my AppDelegate to see what value was returned from the function. Calling print object on the <code>CFTypeRef</code> gave me a plain old 0. I was curious what I would see when I looked at what was set on the BundleName of the Info.plist.</p>

<h3>Corrupt Info.plist</h3>

<p>Not surprisingly, the type column of the bundle name said Boolean and the value was NO. A quick revert to the plist and everything worked out great. I was pretty sure this was a mistake, so I checked the commit history to see if this whether always the case: <code>git log -p --follow Project/Info.plist</code></p>
<div class="highlight"><pre><code class="language-diff" data-lang="diff"><span class="gu">@@ -11,7 +11,7 @@</span>
        &lt;key&gt;CFBundleInfoDictionaryVersion&lt;/key&gt;
        &lt;string&gt;6.0&lt;/string&gt;
        &lt;key&gt;CFBundleName&lt;/key&gt;
<span class="gd">-       &lt;string&gt;$(PRODUCT_NAME)&lt;/string&gt;</span>
<span class="gi">+       &lt;false/&gt;</span>
        &lt;key&gt;CFBundlePackageType&lt;/key&gt;
        &lt;string&gt;APPL&lt;/string&gt;
        &lt;key&gt;CFBundleShortVersionString&lt;/key&gt;
</code></pre></div>
<p>Lo and behold, it was indeed an accident. But sometimes, accidents present the most interesting problems. Who knew that having a faulty bundle name would prevent you from writing files to disk?</p>

<p>To recap: we started with a crash, a stack trace, inspecting registers, a poor attempt at monkey patching, disassembling Foundation using Hopper.app, and finally circling back to the corrupt Info.plist file. Careful eyes probably could have spotted this mistake by searching through the commit history, but that&#39;s not always the case. At any rate, I had a lot of fun doing some code spelunking!</p>

          <div class="meta">
            <p class="date-publish">
              Published:
              <date class="date-pub" title="2015-02-10T00:00:00-06:00" datetime="2015-02-10T00:00:00-06:00" pubdate>
              <span class="month"><abbr>February</abbr></span>
              <span class="day">10</span>
              <span class="year">2015</span>
              </date>
            </p>
          </div><!-- meta -->
          
          <div class="comments">
            
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'marksandsgithub'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            
          </div><!-- comments -->
        </div><!-- entry-content -->
      </div><!-- bd -->
      <footer class="unit-foot">
        <div class="unit-inner unit-foot-inner">
          <nav class="pagination">
            <ul>
              
              <li class="prev"><a class="internal" rel="prev"  href="/2015/2/7/reacting-to-reactive-cocoa-part-iv.html" title="View Reacting to Reactive Cocoa Part IV">&laquo; Reacting to Reactive Cocoa Part IV</a></li>
              
              
              
            </ul>
          </nav>
      </footer>

    </div><!-- content -->
  </div><!-- unit-inner -->
</article>

              </div>
            </div><!-- unit-inner -->
          </div><!-- unit-body -->
        </div><!-- body -->

      </div><!-- page -->

		<script>
			/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
			(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
		</script>
      
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-41405801-1', 'marksands.github.io');
			ga('send', 'pageview');
		</script>

		<script type="text/javascript">var _kmq = _kmq || [];
			var _kmk = _kmk || '61c42d0613ba9e478d7963a3e2e30d87c185d1bf';
			function _kms(u){
			  setTimeout(function(){
			    var d = document, f = d.getElementsByTagName('script')[0],
			    s = d.createElement('script');
			    s.type = 'text/javascript'; s.async = true; s.src = u;
			    f.parentNode.insertBefore(s, f);
			  }, 1);
			}
			_kms('//i.kissmetrics.com/i.js');
			_kms('//doug1izaerwt3.cloudfront.net/' + _kmk + '.1.js');
		</script>

    </body>
</html>
