<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>Pragma Poison | Mark Sands</title>
	<meta name="description" content="stringValueIt can be tempting to convert NSNumbers to strings by calling stringValue. It’s definitely less verbose than creating an NSNumberFormatter, specif...">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<!-- CSS -->
	<link rel="stylesheet" href="/css/main.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="http://localhost:4000/2014/10/16/pragma-poison.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="Mark Sands" href="http://localhost:4000/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">
	

	<!-- KaTeX -->
	

	<!-- Google Analytics -->
	
	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-41405801-1', 'auto');
	ga('send', 'pageview');
	</script>
	
</head>

  <body>
    <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="https://secure.gravatar.com/avatar/7a6e4cc366f8f533b056936cf9bcb85d?s=100" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">Mark Sands</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			
			
			
			
			<li>
				<a class="page-link" href="/about/">
					About
				</a>
			</li>
			
			
			
			
			
			
			
			
			<!-- Social icons from Font Awesome, if enabled -->
			
<li>
	<a href="http://localhost:4000/feed.xml" title="Follow RSS feed">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>



<li>
	<a href="mailto:marksands07@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>













<li>
	<a href="https://github.com/marksands" title="Follow on GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>





















<li>
	<a href="https://twitter.com/marksands" title="Follow on Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>






		</ul>
	</nav>
</header>

    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">Pragma Poison</h1>
    <p class="meta">
    October 16, 2014
    
    </p>
  </header>
  <section class="post-content"><h3 id="stringvalue">stringValue</h3>

<p>It can be tempting to convert NSNumbers to strings by calling <code class="highlighter-rouge">stringValue</code>. It’s definitely less verbose than creating an NSNumberFormatter, specifying the number style, removing the grouping separator, and any other setup that’s necessary. You may think calling <code class="highlighter-rouge">[@8.8 stringValue]</code> returns “8.8”, but you’d be wrong; it actually returns “8.800000000000001”. Let’s take a look at what’s going on behind the scenes when we call stringValue to find out why this is happening.</p>

<!-- more -->

<h3 id="behind-the-scenes">Behind the Scenes</h3>

<p>According to Apple’s documentation regarding <code class="highlighter-rouge">stringValue</code>:<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNumber_Class/Reference/Reference.html#//apple_ref/occ/instm/NSNumber/stringValue">¹</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>The string is created by invoking descriptionWithLocale: where locale is nil.
</code></pre>
</div>

<p>So far so good. Let’s see what <code class="highlighter-rouge">descriptionWithLocale:nil</code> is doing. Also according to Apple’s documentation:<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNumber_Class/Reference/Reference.html#//apple_ref/occ/instm/NSNumber/descriptionWithLocale:">²</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>To obtain the string representation, this method invokes NSString’s initWithFormat:locale: method, 
supplying the format based on the type the NSNumber object was created with:
</code></pre>
</div>

<p>and goes on to list the format specifiers that the NSNumber value is casted to. From the chart, we can see that a double gets <code class="highlighter-rouge">%0.16g</code> as the format specifier.</p>

<p>Let’s take what we’ve found and turn it into a single method call. So, <code class="highlighter-rouge">[@8.8 stringValue]</code> actually becomes <code class="highlighter-rouge">[[NSString alloc] initWithFormat:@"%.16g" locale:nil, 8.8]</code>. Now it makes sense why we are getting 16 digits instead of 2! Floating point conversion isn’t perfect, so that’s why we see some numbers like 8.8 become “8.800000000000001” and others such as 8.9 become “8.9”.</p>

<h3 id="pragma-gcc-poison-stringvalue">#pragma GCC poison stringValue</h3>

<p>The bottom line is, in most cases, you never want 16 digits when converting simple doubles into a string. So now that we’ve deduced how <code class="highlighter-rouge">stringValue</code> can turn a 2 digit number into a 16 digit number, how do we prevent our peers from using this API? I came across a <a href="http://stackoverflow.com/questions/17031349/how-do-i-mark-a-uikit-class-or-method-as-deprecated">stackoverflow post</a> for my answer. I tried a similar approach with creating a category and assigning <code class="highlighter-rouge">UNAVAILABLE_ATTRIBUTE</code>, but that wasn’t working for me either.<a href="http://stackoverflow.com/questions/17031349/how-do-i-mark-a-uikit-class-or-method-as-deprecated">³</a></p>

<p>It turns out GCC originally provided a solution to this problem to poison certain identifiers. Thankfully clang has adopted this protocol as well. The posion pragma is designed to work with C symbols, but you can leave off the colon of your selector to make it work with Objective-C. Finally, all you need to do now is add <code class="highlighter-rouge">#pragma GCC poison stringValue</code> in your precompiled header and start replacing those calls with <code class="highlighter-rouge">NSNumberFormatter</code>!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#pragma GCC poison stringValue

ClassUsingStringValue.m:62:12: Attempt to use a poisoned identifier
</code></pre>
</div>

<h3 id="references">References</h3>

<ul>
  <li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNumber_Class/Reference/Reference.html#//apple_ref/occ/instm/NSNumber/stringValue">[1] stringValue</a></li>
  <li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSNumber_Class/Reference/Reference.html#//apple_ref/occ/instm/NSNumber/descriptionWithLocale:">[2] descriptionWithLocale:</a></li>
  <li><a href="http://stackoverflow.com/questions/17031349/how-do-i-mark-a-uikit-class-or-method-as-deprecated">[3] stackoverflow</a></li>
</ul>
</section>
</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <a id="prev-post" href="/2014/09/26/aviator.html">
      <span class="page-title">Aviator</span>
      <span class="nav-label">
        <i class="fa fa-chevron-left"></i> Prev
      </span>
    </a>
    
    
    <a id="next-post" href="/2014/12/29/2015-goals.html">
       <span class="page-title">2015 Goals</span>
       <span class="nav-label">
        Next <i class="fa fa-chevron-right"></i>
       </span>
     </a>
    
</div>


<!-- Disqus -->

<div class="comments">
  <div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'marksandsgithub';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>


    </div>
    


<footer class="site-footer">
	<p class="text">Powered by <a href="http://jekyllrb.com">Jekyll</a>
</p>
</footer>


  </body>
</html>
