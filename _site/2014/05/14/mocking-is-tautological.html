<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Mocking is Tautological</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

      <div id="page" class="hentry">
        
        <header class="the-header">
          <div class="unit-head">
            <div class="unit-inner unit-head-inner">
              <p class="logo"><a href=""></a></p>
              <nav class="nav-global">
                <ul>
                  <li class="github"><a href="http://github.com/marksands">github</a></li>
                  <li class="twitter"><a href="http://twitter.com/marksands">twitter</a></li>
                </ul>
              </nav>
            </div><!-- unit-inner -->
          </div><!-- unit-head -->
        </header>
        
        <div class="body" role="main">
          
          <!-- begin ads -->
          <article class="unit-article layout-page">
            <div class="unit-inner unit-article-inner">
              <div class="content">
                <div class="bd">
                  <div class="entry-content">
                    <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    <ins class="adsbygoogle"
                         style="display:inline-block;width:728px;height:90px"
                         data-ad-client="ca-pub-5267577598224051"
                         data-ad-slot="1897609812"></ins>
                    <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                  </div>
                </div>
              </div>
            </div>
          </article>
          <!-- end ads -->
          
          <div class="unit-body">
            <div class="unit-inner unit-body-inner">
              <div class="entry-content">
                <article class="unit-article layout-post">
  <div class="unit-inner unit-article-inner">
    <div class="content">
      <header>
        <div class="unit-head">
          <div class="unit-inner unit-head-inner">
            <!-- <h1 class="h2 entry-title">Mocking is Tautological</h1> -->
            
            
          </div><!-- unit-inner -->
        </div><!-- unit-head -->
      </header>

      <div class="bd">
        <div class="entry-content">
          <h1>Mocking is Tautological</h1>
          <h3>Black and White</h3>

<p>When writing unit tests using mocks, it forces the developer into whitebox testing. As the tests are supposed to drive the design, one can argue that this allows them to define the dependencies of the business logic in which they are writing the tests. The quandary, though, is that these tests are no longer unit tests as there is a discrepancy between a single unit and a system of functions that interact with many units or dependencies. Furthermore, tests that rely heavily upon mocks wind up with a test suite that has mocks mocking mocks mocking mocks and so forth, which can lead to a broken test suite any time a programmer tries to refactor in, or out, another dependency.</p>

<p>On the other hand, blackbox testing provides a much better hands off approach to implementation details, namely dependencies. In DI heavy software architecture, blockbox testing tends to be difficult without having the ability to mock and stub internal details. If you only rely on the Given-When-Then formula, then tests should only be concerned with input and output. Stated another way, mocks, expects, and verifies should be replaced with independent objects and assertions. Gary Bernhardt articulates this better than I can in his talk Boundaries.ยน</p>

<h3>Dependencies and Decisions</h3>

<p>When many dependencies, or units, are involved in a path or decision then you should write an integration test instead of mocking out dependencies for an &quot;isolated&quot; unit test. The only time this becomes painful is when multiple decisions in a path directly rely on multiple dependencies; this tends to reek of a code smell. One solution is to split dependencies and decisions into separate layers. Gary&#39;s talk above calls this the functional core and the imperative shell. In the imperative shell, many dependencies work together to formulate a single path with zero conditionals and decisions, while the decisions are deferred to each individual unit formulating the functional core. This makes the majority of testing pains go away.</p>

<p>The functional core can be fully unit tested with every decision having a test. And instead of unit testing the imperative shell, a single integration test will suffice for each component. The rules I follow are: when you find yourself testing a component with many dependencies, don&#39;t use mocks; instead, write an integration test. Refactor until most, if not all, decisions are deferred to each dependency and drive out the implementation using TDD.</p>

<h3>A Rant</h3>

<p>This approach confirms most of my suspicions about using mocks in testing. Mocking (done wrong, and it is often done wrong) is tautological. I&#39;ve both written code and I&#39;ve seen code that mocks a dependency, stubs a method to return a result, and verifies that the method was called and the result was the expected output. I&#39;ve never appreciated this style and it usually feels as though I&#39;m ticking a box off of the test code coverage list. I remain unconvinced that this provides any benefits in opposition to an integration test.</p>

<p>With a test suite that reflects the style of mocks mocking mocks mocking mocks, refactoring can be a major testing pain. If you modify, add, or remove a dependency, chances are a lot of the mocks and method stubs in your tests will no longer be valid. I wouldn&#39;t be surprised if such a simple change broke an entire test class littered with mocks.</p>

<h3>A Resolution</h3>

<p>1 Corinthians 1:13 says, &quot;When I was a child, I spoke as a child, I understood as a child, I thought as a child: but when I became a man, I put away childish things.&quot; Fortunately, I have put aside my days of mocking. I have felt the pains and drawn my losses, choosing to revisit testing and figure out how to fix the problem. I have been experimenting with a side project attempting to separate the functional core from the imperative shell. It is not easy to remove every conditional from the shell, but it has definitely been a relief for testing. And now that my unit tests only use real objects and assertions, I no longer have to choose between which testing and mocking framework to include in my project. I would encourage you to try this approach and see for yourself if it changes the way you test your code.</p>

<h3>References</h3>

<ul>
<li><a href="https://www.destroyallsoftware.com/talks/boundaries">[1] Boundaries</a></li>
</ul>

          <div class="meta">
            <p class="date-publish">
              Published:
              <date class="date-pub" title="2014-05-14T00:00:00-05:00" datetime="2014-05-14T00:00:00-05:00" pubdate>
              <span class="month"><abbr>May</abbr></span>
              <span class="day">14</span>
              <span class="year">2014</span>
              </date>
            </p>
          </div><!-- meta -->
          
          <div class="comments">
            
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'marksandsgithub'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            
          </div><!-- comments -->
        </div><!-- entry-content -->
      </div><!-- bd -->
      <footer class="unit-foot">
        <div class="unit-inner unit-foot-inner">
          <nav class="pagination">
            <ul>
              
              <li class="prev"><a class="internal" rel="prev"  href="/2014/01/03/inspecting-third-party-apps.html" title="View Inspecting Third Party Apps">&laquo; Inspecting Third Party Apps</a></li>
              
              
              <li class="pipe"> | </li>
              
              
              <li class="next"><a class="internal" rel="next"  href="/2014/05/20/effective-programming.html" title="View Effective Programming">Effective Programming &raquo;</a></li>
              
            </ul>
          </nav>
      </footer>

    </div><!-- content -->
  </div><!-- unit-inner -->
</article>

              </div>
            </div><!-- unit-inner -->
          </div><!-- unit-body -->
        </div><!-- body -->

      </div><!-- page -->

		<script>
			/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
			(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
		</script>
      
		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-41405801-1', 'marksands.github.io');
			ga('send', 'pageview');
		</script>

		<script type="text/javascript">var _kmq = _kmq || [];
			var _kmk = _kmk || '61c42d0613ba9e478d7963a3e2e30d87c185d1bf';
			function _kms(u){
			  setTimeout(function(){
			    var d = document, f = d.getElementsByTagName('script')[0],
			    s = d.createElement('script');
			    s.type = 'text/javascript'; s.async = true; s.src = u;
			    f.parentNode.insertBefore(s, f);
			  }, 1);
			}
			_kms('//i.kissmetrics.com/i.js');
			_kms('//doug1izaerwt3.cloudfront.net/' + _kmk + '.1.js');
		</script>

    </body>
</html>
